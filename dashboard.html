<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Group 11</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        .stats-card {
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">üè† Group 11 Dashboard</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userInfo">ƒêang t·∫£i...</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User Info Section -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title" id="welcomeMessage">Ch√†o m·ª´ng!</h5>
                        <p class="card-text" id="userDetails">ƒêang t·∫£i th√¥ng tin...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6>üë§ Avatar</h6>
                        <div id="avatarSection">
                            <img id="userAvatar" src="https://via.placeholder.com/100x100?text=No+Avatar" 
                                 class="rounded-circle mb-2" width="100" height="100" alt="User Avatar">
                            <br>
                            <small class="text-muted">Ch∆∞a c√≥ avatar</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role-based Content -->
        <div class="row">
            <!-- Admin Panel -->
            <div id="adminPanel" class="col-12" style="display: none;">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5>üëë Admin Panel</h5>
                    </div>
                    <div class="card-body">
                        <h6>üîß Qu·∫£n l√Ω h·ªá th·ªëng</h6>
                        <div class="row">
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-info text-white stats-card">
                                    <div class="card-body text-center">
                                        <h4>üë•</h4>
                                        <h5 id="totalUsers">-</h5>
                                        <p class="mb-0">T·ªïng s·ªë ng∆∞·ªùi d√πng</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-success text-white stats-card">
                                    <div class="card-body text-center">
                                        <h4>üìä</h4>
                                        <h5>100%</h5>
                                        <p class="mb-0">H·ªá th·ªëng ho·∫°t ƒë·ªông</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-warning text-dark stats-card">
                                    <div class="card-body text-center">
                                        <h4>üîê</h4>
                                        <h5>RBAC</h5>
                                        <p class="mb-0">Ph√¢n quy·ªÅn active</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-danger" onclick="loadAllUsers()">üìã Xem t·∫•t c·∫£ ng∆∞·ªùi d√πng</button>
                            <button class="btn btn-success" onclick="showAddUserModal()">‚ûï Th√™m ng∆∞·ªùi d√πng</button>
                            <button class="btn btn-warning" onclick="showAdminTools()">‚öôÔ∏è C√¥ng c·ª• Admin</button>
                            <button class="btn btn-info" onclick="showPasswordResetTool()">üîë Reset m·∫≠t kh·∫©u</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moderator Panel -->
            <div id="moderatorPanel" class="col-12" style="display: none;">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5>üõ°Ô∏è Moderator Panel</h5>
                    </div>
                    <div class="card-body">
                        <h6>üìù Qu·∫£n l√Ω n·ªôi dung</h6>
                        <div class="row">
                            <div class="col-lg-6 col-md-6 mb-3">
                                <div class="card bg-secondary text-white stats-card">
                                    <div class="card-body text-center">
                                        <h4>üìã</h4>
                                        <h5>5</h5>
                                        <p class="mb-0">B√°o c√°o ch·ªù x·ª≠ l√Ω</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 mb-3">
                                <div class="card bg-primary text-white stats-card">
                                    <div class="card-body text-center">
                                        <h4>‚úÖ</h4>
                                        <h5>23</h5>
                                        <p class="mb-0">ƒê√£ x·ª≠ l√Ω h√¥m nay</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-warning" onclick="showReports()">üìä Xem b√°o c√°o</button>
                            <button class="btn btn-info" onclick="showModTools()">üîß C√¥ng c·ª• Moderator</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Panel -->
            <div id="userPanel" class="col-12" style="display: none;">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5>üë§ User Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <h6>üìä Th·ªëng k√™ c√° nh√¢n</h6>
                        <div class="row">
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-light stats-card">
                                    <div class="card-body text-center">
                                        <h4>üìà</h4>
                                        <h5>12</h5>
                                        <p class="mb-0">Ho·∫°t ƒë·ªông</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-light stats-card">
                                    <div class="card-body text-center">
                                        <h4>üéØ</h4>
                                        <h5>8</h5>
                                        <p class="mb-0">M·ª•c ti√™u ho√†n th√†nh</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card bg-light stats-card">
                                    <div class="card-body text-center">
                                        <h4>‚≠ê</h4>
                                        <h5>4.5</h5>
                                        <p class="mb-0">ƒêi·ªÉm ƒë√°nh gi√°</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success" onclick="showProfile()">üë§ Xem h·ªì s∆°</button>
                            <button class="btn btn-primary" onclick="showActivity()">üìä Ho·∫°t ƒë·ªông</button>
                            <button class="btn btn-info" onclick="uploadAvatar()">üì∑ Upload Avatar</button>
                            <button class="btn btn-secondary" onclick="changePassword()">üîí ƒê·ªïi m·∫≠t kh·∫©u</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Common Features -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üîÑ Demo Refresh Token & Session Management</h5>
                    </div>
                    <div class="card-body">
                        <p>·ª®ng d·ª•ng n√†y demo t√≠nh nƒÉng <strong>Refresh Token & Session Management</strong> + <strong>RBAC</strong>:</p>
                        <ul>
                            <li>‚úÖ <strong>Access Token:</strong> H·∫øt h·∫°n sau 15 ph√∫t</li>
                            <li>‚úÖ <strong>Refresh Token:</strong> H·∫øt h·∫°n sau 7 ng√†y</li>
                            <li>‚úÖ <strong>Auto Refresh:</strong> T·ª± ƒë·ªông l√†m m·ªõi token khi h·∫øt h·∫°n</li>
                            <li>‚úÖ <strong>Token Rotation:</strong> T·∫°o token m·ªõi m·ªói l·∫ßn refresh</li>
                            <li>‚úÖ <strong>Secure Logout:</strong> Thu h·ªìi token khi ƒëƒÉng xu·∫•t</li>
                            <li>üî• <strong>RBAC:</strong> Ph√¢n quy·ªÅn Admin/Moderator/User</li>
                        </ul>
                        
                        <div id="usersList" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Refresh user data from server
        async function refreshUserData() {
            const token = localStorage.getItem('token');
            
            try {
                console.log('üîÑ Refreshing user data from server...');
                console.log('üé´ Using token:', token);
                
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì¨ API Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Fresh user data from server:', result.user);
                    console.log('üñºÔ∏è Avatar in response:', result.user.avatar);
                    
                    // Update localStorage with fresh data
                    localStorage.setItem('user', JSON.stringify(result.user));
                    console.log('üíæ Updated localStorage with fresh data');
                } else {
                    console.log('‚ö†Ô∏è Failed to refresh user data, using cached data');
                    console.log('‚ùå Response:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Error refreshing user data:', error);
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            const token = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem('user') || '{}');

            if (!token || !user.id) {
                alert('‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                window.location.href = 'login.html';
                return;
            }

            // Refresh user data from server
            await refreshUserData();
            
            // Get updated user data
            user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Display user info
            document.getElementById('userInfo').textContent = `üëã ${user.name} (${user.role})`;
            document.getElementById('welcomeMessage').textContent = `Ch√†o m·ª´ng, ${user.name}!`;
            document.getElementById('userDetails').textContent = `Email: ${user.email} | Role: ${user.role.toUpperCase()} | ID: ${user.id}`;
            
            // Display user avatar if exists
            console.log('üë§ User data after refresh:', user);
            if (user.avatar) {
                console.log('üñºÔ∏è Displaying avatar:', user.avatar);
                displayUserAvatar(user.avatar);
            } else {
                console.log('‚ùå No avatar found for user');
            }

            // Show role-specific panels
            showRolePanel();
            
            // Auto-load users for admin
            if (user.role === 'admin') {
                loadAllUsers();
            }
        }

        // Call init function
        initDashboard();

        // Show role-specific panels
        function showRolePanel() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const role = user.role.toLowerCase();
            
            // Hide all panels
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('moderatorPanel').style.display = 'none';
            document.getElementById('userPanel').style.display = 'none';
            
            // Show appropriate panel
            if (role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            } else if (role === 'moderator') {
                document.getElementById('moderatorPanel').style.display = 'block';
            } else {
                document.getElementById('userPanel').style.display = 'block';
            }
        }

        // Load all users (Admin only)
        async function loadAllUsers() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            console.log('üîç Loading users...', { userRole: user.role, token: token });
            
            if (user.role !== 'admin') {
                alert('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn xem danh s√°ch ng∆∞·ªùi d√πng!');
                return;
            }

            try {
                console.log('üì° Sending request to /api/auth/users');
                const response = await fetch('/api/auth/users', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì¨ Response received:', { status: response.status, ok: response.ok });
                
                const data = await response.json();
                console.log('üìÑ Response data:', data);

                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.users.length;
                    
                    let html = '<h6>üë• Danh s√°ch ng∆∞·ªùi d√πng:</h6><div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>Avatar</th><th>ID</th><th>T√™n</th><th>Email</th><th>Role</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody>';
                    
                    data.users.forEach(u => {
                        const roleColor = u.role === 'admin' ? 'danger' : u.role === 'moderator' ? 'warning' : 'success';
                        const isCurrentUser = u.id === user.id;
                        const avatarUrl = u.avatar || 'https://via.placeholder.com/40x40?text=No+Avatar';
                        html += `<tr>
                            <td><img src="${avatarUrl}" class="rounded-circle" width="40" height="40" alt="Avatar" style="object-fit: cover;"></td>
                            <td>${u.id}</td>
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td><span class="badge bg-${roleColor}">${u.role.toUpperCase()}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editUser('${u.id}')">‚úèÔ∏è S·ª≠a</button>
                                ${!isCurrentUser ? `<button class="btn btn-sm btn-danger ms-1" onclick="deleteUser('${u.id}', '${u.name}')">üóëÔ∏è X√≥a</button>` : ''}
                                <button class="btn btn-sm btn-warning ms-1" onclick="resetPassword('${u.id}', '${u.name}')">üîë Reset PW</button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    document.getElementById('usersList').innerHTML = html;
                    
                    console.log('‚úÖ Users loaded successfully');
                } else {
                    console.error('‚ùå API Error:', data.message);
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('üí• Network Error:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        // Admin tools
        function showAdminTools() {
            alert('üîß Admin Tools:\n\n‚Ä¢ Qu·∫£n l√Ω ng∆∞·ªùi d√πng\n‚Ä¢ C·∫•u h√¨nh h·ªá th·ªëng\n‚Ä¢ Xem logs\n‚Ä¢ Backup/Restore\n\n(Demo function)');
        }

        // Add User Modal
        function showAddUserModal() {
            const name = prompt('üë§ Nh·∫≠p t√™n ng∆∞·ªùi d√πng:');
            if (!name) return;
            
            const email = prompt('üìß Nh·∫≠p email:');
            if (!email) return;
            
            const password = prompt('üîí Nh·∫≠p m·∫≠t kh·∫©u:');
            if (!password) return;
            
            const role = prompt('üé≠ Nh·∫≠p role (user/moderator/admin):');
            if (!role || !['user', 'moderator', 'admin'].includes(role)) {
                alert('‚ùå Role kh√¥ng h·ª£p l·ªá!');
                return;
            }
            
            addUser(name, email, password, role);
        }

        // Add user function
        async function addUser(name, email, password, role) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, email, password, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                    loadAllUsers(); // Reload list
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Edit user
        async function editUser(userId) {
            const token = localStorage.getItem('token');
            
            const newName = prompt('üë§ Nh·∫≠p t√™n m·ªõi:');
            if (!newName) return;
            
            const newRole = prompt('üé≠ Nh·∫≠p role m·ªõi (user/moderator/admin):');
            if (!newRole || !['user', 'moderator', 'admin'].includes(newRole)) {
                alert('‚ùå Role kh√¥ng h·ª£p l·ªá!');
                return;
            }
            
            try {
                const response = await fetch(`/api/auth/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name: newName, role: newRole })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadAllUsers(); // Reload list
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Delete user
        async function deleteUser(userId, userName) {
            const token = localStorage.getItem('token');
            
            if (confirm(`üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${userName}"?`)) {
                try {
                    const response = await fetch(`/api/auth/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(`‚úÖ ${data.message}`);
                        loadAllUsers(); // Reload list
                    } else {
                        alert('‚ùå ' + data.message);
                    }
                } catch (error) {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            }
        }

        // Reset password
        async function resetPassword(userId, userName) {
            const token = localStorage.getItem('token');
            
            const newPassword = prompt(`üîë Nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho "${userName}":`);
            if (!newPassword) return;
            
            try {
                const response = await fetch(`/api/auth/users/${userId}/reset-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}\nM·∫≠t kh·∫©u m·ªõi: ${newPassword}`);
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Password reset tool for admin
        function showPasswordResetTool() {
            const email = prompt('üìß Nh·∫≠p email ƒë·ªÉ reset m·∫≠t kh·∫©u:');
            if (email) {
                // Demo function
                alert(`‚úÖ ƒê√£ g·ª≠i link reset m·∫≠t kh·∫©u ƒë·∫øn: ${email}\n\n(Demo function)`);
            }
        }

        // Moderator functions
        function showReports() {
            alert('üìä Moderator Reports:\n\n‚Ä¢ 5 b√°o c√°o ch·ªù x·ª≠ l√Ω\n‚Ä¢ 23 ƒë√£ x·ª≠ l√Ω h√¥m nay\n‚Ä¢ 150 t·ªïng b√°o c√°o th√°ng\n\n(Demo function)');
        }

        function showModTools() {
            alert('üîß Moderator Tools:\n\n‚Ä¢ Duy·ªát n·ªôi dung\n‚Ä¢ X·ª≠ l√Ω b√°o c√°o\n‚Ä¢ Qu·∫£n l√Ω comment\n‚Ä¢ Ban/Unban user\n\n(Demo function)');
        }

        // User functions
        function showProfile() {
            alert(`üë§ H·ªì s∆° c·ªßa ${user.name}:\n\nEmail: ${user.email}\nRole: ${user.role}\nTham gia: 2024\nƒêi·ªÉm: 4.5/5\n\n(Demo function)`);
        }

        function showActivity() {
            alert('üìä Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y:\n\n‚Ä¢ ƒêƒÉng nh·∫≠p: H√¥m nay 10:30\n‚Ä¢ C·∫≠p nh·∫≠t profile: 2 ng√†y tr∆∞·ªõc\n‚Ä¢ Ho√†n th√†nh task: 3 ng√†y tr∆∞·ªõc\n\n(Demo function)');
        }

        // Display user avatar
        function displayUserAvatar(avatarUrl) {
            const avatarImg = document.getElementById('userAvatar');
            const avatarSection = document.querySelector('#avatarSection small');
            
            console.log('üé® Setting avatar image:', avatarUrl);
            
            // Handle image load success
            avatarImg.onload = function() {
                console.log('‚úÖ Avatar loaded successfully');
                avatarImg.style.border = '3px solid #28a745';
                avatarSection.textContent = 'Avatar ƒë√£ c·∫≠p nh·∫≠t';
                avatarSection.style.color = '#28a745';
            };
            
            // Handle image load error
            avatarImg.onerror = function() {
                console.error('‚ùå Failed to load avatar:', avatarUrl);
                avatarImg.src = 'https://via.placeholder.com/100x100?text=Error';
                avatarImg.style.border = '3px solid #dc3545';
                avatarSection.textContent = 'L·ªói t·∫£i avatar';
                avatarSection.style.color = '#dc3545';
            };
            
            avatarImg.src = avatarUrl;
        }

        // Upload Avatar
        function uploadAvatar() {
            // Redirect to dedicated upload page
            window.location.href = 'upload-avatar.html';
        }

        // Change Password
        function changePassword() {
            const currentPassword = prompt('üîí Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i:');
            if (!currentPassword) return;
            
            const newPassword = prompt('üÜï Nh·∫≠p m·∫≠t kh·∫©u m·ªõi:');
            if (!newPassword) return;
            
            const confirmPassword = prompt('‚úÖ X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi:');
            if (newPassword !== confirmPassword) {
                alert('‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                return;
            }
            
            // Demo function - trong th·ª±c t·∫ø s·∫Ω g·ªçi API
            alert(`‚úÖ ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!\n\n(Demo function)`);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            alert('üëã ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
            window.location.href = 'login.html';
        }

        // Initialize page
        showRolePanel();

        // Auto-load users for admin - moved to initDashboard()
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>