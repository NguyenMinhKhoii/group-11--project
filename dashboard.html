<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Group 11 Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      background: #f8f9fa;
      min-height: 100vh; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 80px;
    }
    .navbar { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0,0,0,0.15);
      padding: 1rem 0;
    }
    .container {
      max-width: 1400px;
      padding: 0 2rem;
    }
    .card { 
      border-radius: 20px; 
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      border: none;
      margin-bottom: 2rem;
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    .card-success { background: linear-gradient(135deg, #10b981, #047857); color: white; }
    .card-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .card-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .card-body {
      padding: 2.5rem;
    }
    .avatar-container {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #dc3545;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
    }
    .stats-card {
      text-align: center;
      padding: 1.5rem;
    }
    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .btn-custom {
      border-radius: 30px;
      padding: 15px 35px;
      font-weight: 700;
      margin: 8px;
      font-size: 1rem;
      min-width: 180px;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-custom:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    }
    .welcome-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 25px;
      padding: 3rem 2rem;
      margin-bottom: 3rem;
      text-align: center;
    }
    .dashboard-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
    }
    .role-badge { 
      background: #fbbf24; 
      color: #92400e; 
      padding: 4px 12px; 
      border-radius: 12px; 
      font-size: 0.875rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <div class="navbar-brand fw-bold">
        <span class="text-primary">üè†</span> Group 11 Dashboard
      </div>
      <div class="d-flex align-items-center">
        <span class="me-3">
          <span class="role-badge" id="navUserRole">Regular User (user)</span>
        </span>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card card-primary p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h3 class="mb-2">Ch√†o m·ª´ng, <span id="userName">Regular User</span>!</h3>
              <p class="mb-1">Email: <span id="userEmail">user@gmail.com</span> | Role: <span id="userRoleText">USER</span> | ID: <span id="userId">3</span></p>
              <p class="mb-0 opacity-75">Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i v·ªõi h·ªá th·ªëng qu·∫£n l√Ω Group 11</p>
            </div>
            <div class="col-md-4 text-center">
              <div class="d-flex flex-column align-items-center">
                <div class="avatar-container mb-2" id="avatarContainer">
                  <img id="userAvatar" src="https://via.placeholder.com/100/cccccc/666666?text=Avatar" alt="Avatar" class="w-100 h-100 rounded-circle object-fit-cover">
                </div>
                <small class="text-white opacity-75">Avatar</small>
                <small id="avatarErrorText" class="text-white opacity-50" style="display:none">L·ªói t·∫£i avatar</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dynamic Dashboard Panel -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card card-success p-4">
          <h4 class="mb-4" id="dashboardTitle">
            <i class="bi bi-person-circle"></i> User Dashboard
          </h4>
          
          <!-- Statistics -->
          <div class="row mb-4" id="statsSection">
            <div class="col-md-4">
              <div class="stats-card">
                <div class="stats-number" id="stat1">üìù 12</div>
                <div id="stat1Label">Ho·∫°t ƒë·ªông</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card">
                <div class="stats-number" id="stat2">üéØ 8</div>
                <div id="stat2Label">M·ª•c ti√™u ho√†n th√†nh</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card">
                <div class="stats-number" id="stat3">‚≠ê 4.5</div>
                <div id="stat3Label">ƒêi·ªÉm ƒë√°nh gi√°</div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
            <div class="text-center" id="actionButtons">
            <button class="btn btn-success btn-custom" onclick="window.location.href='profile.html'">
              <i class="bi bi-person"></i> üë§ Xem h·ªì s∆°
            </button>
            <button class="btn btn-primary btn-custom">
              <i class="bi bi-activity"></i> üìä Ho·∫°t ƒë·ªông
            </button>
            <button class="btn btn-info btn-custom" onclick="openAvatarUploadModal()">
              <i class="bi bi-cloud-upload"></i> üì∑ Upload Avatar
            </button>
            <button class="btn btn-warning btn-custom" onclick="window.location.href='profile.html#password'">
              <i class="bi bi-shield-lock"></i> üîí ƒê·ªïi m·∫≠t kh·∫©u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin User Management -->
    <div id="adminUserManagement" class="row mb-4" style="display: none;">
      <div class="col-12">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-primary">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng (Admin)</h4>
            <button class="btn btn-success btn-sm" onclick="refreshUserList()">üîÑ L√†m m·ªõi</button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Avatar</th>
                  <th>T√™n</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr>
                  <td colspan="6" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Add User Form -->
          <div class="mt-4 p-3 bg-light rounded">
            <h6>‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi:</h6>
            <form id="addUserForm" class="row g-2">
              <div class="col-md-3">
                <input type="text" class="form-control" id="newUserName" placeholder="T√™n ƒë·∫ßy ƒë·ªß" required>
              </div>
              <div class="col-md-3">
                <input type="email" class="form-control" id="newUserEmail" placeholder="Email" required>
              </div>
              <div class="col-md-2">
                <input type="password" class="form-control" id="newUserPassword" placeholder="M·∫≠t kh·∫©u" required>
              </div>
              <div class="col-md-2">
                <select class="form-control" id="newUserRole" required>
                  <option value="user">User</option>
                  <option value="moderator">Moderator</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Th√™m</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo Refresh Token Section -->
    <div class="row">
      <div class="col-12">
        <div class="card p-4" style="background: linear-gradient(135deg, #e0f2fe, #b3e5fc);">
          <h5 class="text-primary mb-3">
            <i class="bi bi-arrow-clockwise"></i> üîÑ Demo Refresh Token
          </h5>
          <p class="mb-3">·ª®ng d·ª•ng n√†y demo t√≠nh nƒÉng <strong>Refresh Token & Session Management</strong>:</p>
          
          <div class="row">
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i> 
                  <strong>Access Token:</strong> H·∫øt h·∫°n sau 15 ph√∫t
                </li>
                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <strong>Refresh Token:</strong> H·∫øt h·∫°n sau 7 ng√†y
                </li>
                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <strong>Auto Refresh:</strong> T·ª± ƒë·ªông l√†m m·ªõi token khi h·∫øt h·∫°n
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <strong>Token Rotation:</strong> T·∫°o token m·ªõi m·ªói l·∫ßn refresh
                </li>
                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <strong>Secure Logout:</strong> Thu h·ªìi token khi ƒëƒÉng xu·∫•t
                </li>
              </ul>
              
              <!-- Demo Controls -->
              <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="demoRefreshToken()">
                  üîÑ Test Refresh Token
                </button>
                <button class="btn btn-outline-warning btn-sm me-2" onclick="demoExpireToken()">
                  ‚è∞ Simulate Token Expiry
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showTokenInfo()">
                  ‚ÑπÔ∏è View Token Info
                </button>
              </div>
            </div>
          </div>
          
          <!-- Token Status Display -->
          <div id="tokenStatus" class="mt-3 p-3 bg-light rounded" style="display: none;">
            <h6>Token Status:</h6>
            <div id="tokenDetails"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load avatar helper (injects real avatar when JWT present) -->
  <script src="/public/js/load-avatar.js"></script>

 <script>
    // Load user data on page load
    window.addEventListener('load', () => {
        loadUserData();
    });

    function loadUserData() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!user.email) {
            // Show test login buttons if no user logged in
            showTestLoginOptions();
        } else {
            displayUserData(user);
      // After displaying local user data, attempt to replace avatar with server-stored avatar
      if (window.loadAvatarInto) {
        window.loadAvatarInto('#avatarContainer').catch(err => console.error(err));
      }
        }
    }

    function displayUserData(user) {
        // Display user info in welcome section
        document.getElementById('userName').textContent = user.fullname || user.name || 'Regular User';
        document.getElementById('userEmail').textContent = user.email || 'user@gmail.com';
        document.getElementById('userRoleText').textContent = (user.role || 'user').toUpperCase();
        document.getElementById('userId').textContent = user.id || '3';
        
        // Display role in navbar
        const roleText = user.role === 'admin' ? 'Admin (admin)' : 
                        user.role === 'moderator' ? 'Moderator (moderator)' : 
                        'Regular User (user)';
        document.getElementById('navUserRole').textContent = roleText;
        
        // Display avatar with better error handling
        const avatarElement = document.getElementById('userAvatar');
        const avatarUrl = user.avatar || `https://via.placeholder.com/120/667eea/white?text=${encodeURIComponent(user.fullname || 'User')}`;
        
        console.log('üñºÔ∏è Dashboard avatar URL:', avatarUrl);
        avatarElement.src = avatarUrl;
        
        // Add comprehensive error handling
    const avatarErrorText = document.getElementById('avatarErrorText');
    avatarElement.onerror = function() {
      console.log('‚ùå Dashboard avatar load failed, using fallback');
      this.src = `https://via.placeholder.com/120/cccccc/666666?text=${encodeURIComponent(user.fullname || 'Avatar')}`;
      this.onerror = null; // Prevent infinite loop
      if (avatarErrorText) avatarErrorText.style.display = 'block';
    };
        
    avatarElement.onload = function() {
      console.log('‚úÖ Dashboard avatar loaded successfully');
      if (avatarErrorText) avatarErrorText.style.display = 'none';
    };

        // Show appropriate panels based on role
        const userDashboard = document.querySelector('.card-success') || document.querySelector('.card'); // User Dashboard panel
        const adminPanel = document.getElementById('adminUserManagement');
        const dashboardTitle = document.getElementById('dashboardTitle');
        
        // Update statistics and action buttons based on role
        if (user.role === 'admin') {
            // Update title for Admin
            dashboardTitle.innerHTML = '<i class="bi bi-crown"></i> üëë Admin Panel - User Management';
            userDashboard.classList.remove('card-success');
            userDashboard.classList.add('card-danger');
            
            // Update statistics for admin
            document.getElementById('userStat').textContent = '45';
            document.getElementById('sessionStat').textContent = '12';
            document.getElementById('activityStat').textContent = '234';
            
            // Update labels for admin context
            document.querySelector('.card-body .row .col-4:nth-child(1) p.text-muted').textContent = 'Total Users';
            document.querySelector('.card-body .row .col-4:nth-child(2) p.text-muted').textContent = 'Active Sessions';
            document.querySelector('.card-body .row .col-4:nth-child(3) p.text-muted').textContent = 'System Activities';
            
            // Update action buttons for admin
            document.getElementById('actionButtons').innerHTML = `
              <button class="btn btn-danger btn-custom">
                <i class="bi bi-people"></i> üë• Qu·∫£n l√Ω User
              </button>
              <button class="btn btn-warning btn-custom">
                <i class="bi bi-shield"></i> üõ°Ô∏è Ph√¢n quy·ªÅn
              </button>
              <button class="btn btn-info btn-custom">
                <i class="bi bi-graph-up"></i> üìà Th·ªëng k√™
              </button>
              <button class="btn btn-secondary btn-custom">
                <i class="bi bi-gear"></i> ‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng
              </button>
            `;
            
            adminPanel.style.display = 'block';
            loadUserList();
            
        } else if (user.role === 'moderator') {
            // Update title for Moderator  
            dashboardTitle.innerHTML = '<i class="bi bi-shield-check"></i> üõ°Ô∏è Moderator Panel';
            userDashboard.classList.remove('card-success');
            userDashboard.classList.add('card-warning');
            
            // Update statistics for moderator
            document.getElementById('userStat').textContent = '18';
            document.getElementById('sessionStat').textContent = '8';
            document.getElementById('activityStat').textContent = '156';
            
            // Update labels for moderator context
            document.querySelector('.card-body .row .col-4:nth-child(1) p.text-muted').textContent = 'Managed Users';
            document.querySelector('.card-body .row .col-4:nth-child(2) p.text-muted').textContent = 'Active Reports';
            document.querySelector('.card-body .row .col-4:nth-child(3) p.text-muted').textContent = 'Resolved Issues';
            
            // Update action buttons for moderator
            document.getElementById('actionButtons').innerHTML = `
              <button class="btn btn-warning btn-custom">
                <i class="bi bi-flag"></i> üö© B√°o c√°o
              </button>
              <button class="btn btn-primary btn-custom">
                <i class="bi bi-eye"></i> üëÅÔ∏è Gi√°m s√°t
              </button>
              <button class="btn btn-info btn-custom" onclick="window.location.href='upload-avatar.html'">
                <i class="bi bi-cloud-upload"></i> üì∑ Upload Avatar
              </button>
              <button class="btn btn-success btn-custom">
                <i class="bi bi-check-circle"></i> ‚úÖ Duy·ªát n·ªôi dung
              </button>
            `;
            
            adminPanel.style.display = 'block';
            loadUserList();
            
        } else {
            // Keep User Dashboard
            dashboardTitle.innerHTML = '<i class="bi bi-person-circle"></i> üë§ User Dashboard';
            userDashboard.classList.add('card-success');
            adminPanel.style.display = 'none';
        }
    }

    async function showTestLoginOptions() {
        const dashboardTitle = document.getElementById('dashboardTitle');
        dashboardTitle.innerHTML = 'üîê Vui l√≤ng ƒëƒÉng nh·∫≠p';
        
        // Create login buttons
        const loginSection = document.querySelector('.card-success .card-body');
        if (loginSection) {
            loginSection.innerHTML = `
                <div class="text-center">
                    <h4>üîê Test Login</h4>
                    <p class="mb-4">Ch·ªçn t√†i kho·∫£n ƒë·ªÉ ƒëƒÉng nh·∫≠p:</p>
                    <div class="d-grid gap-3">
                        <button class="btn btn-danger btn-lg" onclick="testLogin('admin')">
                            üëë ƒêƒÉng nh·∫≠p Admin
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="testLogin('user')">
                            üë§ ƒêƒÉng nh·∫≠p User
                        </button>
                        <button class="btn btn-success btn-lg" onclick="window.location.href='login.html'">
                            üîê ƒêƒÉng nh·∫≠p th√¥ng th∆∞·ªùng
                        </button>
                    </div>
                </div>
            `;
        }
    }
    
    async function testLogin(type) {
        const credentials = type === 'admin' 
            ? { email: 'admin@test.com', password: '123456' }
            : { email: 'user@test.com', password: '123456' };
        
        try {
            const response = await fetch('http://localhost:5173/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            });
            
            const data = await response.json();
            console.log('üîê Login response:', data);
            
      if (data.success) {
        // Support response shapes: { success, token, user } and { success, data: { token, user } }
        const respUser = data.user || (data.data && data.data.user) || null;
        const respToken = data.token || (data.data && data.data.token) || null;

        if (respUser) localStorage.setItem('user', JSON.stringify(respUser));
        if (respToken) {
          // store token under both keys for compatibility
          localStorage.setItem('token', respToken);
          localStorage.setItem('authToken', respToken);
        }

        alert('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
        // Try to load avatar immediately (if loader is present)
        if (window.loadAvatarInto) {
          try { window.loadAvatarInto('#avatarContainer'); } catch(e) { console.warn(e); }
        }
        window.location.reload();
      } else {
        alert('‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + data.message);
      }
        } catch (error) {
            console.error('Login error:', error);
            alert('‚ùå L·ªói k·∫øt n·ªëi server!');
        }
    }

    function logout() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
            localStorage.removeItem('user');
      localStorage.removeItem('token');
      localStorage.removeItem('authToken');
            alert('üëã ƒê√£ ƒëƒÉng xu·∫•t!');
      window.location.href = 'login.html';
        }
    }

    // User Management Functions
    let allUsers = [];

    async function loadUserList() {
        try {
            const response = await fetch('http://localhost:5173/api/auth/users');
            const result = await response.json();
            
            if (result.success) {
                allUsers = result.users;
                displayUserList(allUsers);
            } else {
                console.error('Failed to load users:', result.message);
            }
        } catch (error) {
            console.error('Error loading users:', error);
            // Show demo users if API fails
            showDemoUsers();
        }
    }

    function showDemoUsers() {
        allUsers = [
            {
                id: 1,
                fullname: "Admin User",
                email: "admin@test.com",
                role: "admin",
                avatar: "https://via.placeholder.com/50/ff6b6b/white?text=A"
            },
            {
                id: 2,
                fullname: "Moderator User", 
                email: "mod@test.com",
                role: "moderator",
                avatar: "https://via.placeholder.com/50/4ecdc4/white?text=M"
            },
            {
                id: 3,
                fullname: "Regular User",
                email: "user@test.com", 
                role: "user",
                avatar: "https://via.placeholder.com/50/95e1d3/white?text=U"
            }
        ];
        displayUserList(allUsers);
    }

    function displayUserList(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            
            // Role badge colors
            const roleColors = {
                admin: 'bg-danger',
                moderator: 'bg-warning', 
                user: 'bg-success'
            };
            
            row.innerHTML = `
                <td><strong>#${user.id}</strong></td>
                <td>
                    <img src="${user.avatar || 'https://via.placeholder.com/40/ccc/666?text=?'}" 
                         class="rounded-circle" width="40" height="40" 
                         onerror="this.src='https://via.placeholder.com/40/ccc/666?text=?'">
                </td>
                <td><strong>${user.fullname || user.name || 'Unknown'}</strong></td>
                <td>${user.email}</td>
                <td><span class="badge ${roleColors[user.role] || 'bg-secondary'}">${user.role || 'user'}</span></td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editUser('${user.email}')" title="S·ª≠a">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.email}')" title="X√≥a">
                            üóëÔ∏è
                        </button>
                        <button class="btn btn-outline-info" onclick="viewUserDetails('${user.email}')" title="Chi ti·∫øt">
                            üëÅÔ∏è
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function refreshUserList() {
        document.getElementById('userTableBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div>ƒêang t·∫£i l·∫°i...</div>
                </td>
            </tr>
        `;
        setTimeout(() => loadUserList(), 500);
    }

    async function addNewUser(event) {
        event.preventDefault();
        
        const name = document.getElementById('newUserName').value;
        const email = document.getElementById('newUserEmail').value;
        const password = document.getElementById('newUserPassword').value;
        const role = document.getElementById('newUserRole').value;

        try {
            const response = await fetch('http://localhost:5173/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fullname: name, email, password, role })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                document.getElementById('addUserForm').reset();
                loadUserList();
            } else {
                alert('‚ùå L·ªói: ' + result.message);
            }
        } catch (error) {
            alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
        }
    }

    async function deleteUser(email) {
        if (confirm(`üóëÔ∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${email}"?`)) {
            try {
                const response = await fetch(`http://localhost:5173/api/auth/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                    loadUserList();
                } else {
                    alert('‚ùå L·ªói: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }
    }

    function editUser(email) {
        const user = allUsers.find(u => u.email === email);
        if (user) {
            const newName = prompt('T√™n m·ªõi:', user.fullname || user.name);
            const newRole = prompt('Role m·ªõi (admin/moderator/user):', user.role);
            
            if (newName && newRole) {
                updateUser(email, newName, newRole);
            }
        }
    }

    async function updateUser(email, name, role) {
        try {
            const response = await fetch(`http://localhost:5173/api/auth/users/${encodeURIComponent(email)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fullname: name, role })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                loadUserList();
            } else {
                alert('‚ùå L·ªói: ' + result.message);
            }
        } catch (error) {
            alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
        }
    }

    function viewUserDetails(email) {
        const user = allUsers.find(u => u.email === email);
        if (user) {
            alert(`üë§ Chi ti·∫øt ng∆∞·ªùi d√πng:
            
ID: ${user.id}
T√™n: ${user.fullname || user.name}
Email: ${user.email}
Role: ${user.role}
Avatar: ${user.avatar ? 'C√≥' : 'Kh√¥ng'}
            `);
        }
    }

    // Demo Refresh Token Functions
    function demoRefreshToken() {
        const statusDiv = document.getElementById('tokenStatus');
        const detailsDiv = document.getElementById('tokenDetails');
        
        statusDiv.style.display = 'block';
        detailsDiv.innerHTML = `
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>ƒêang refresh token...</span>
        `;
        
        setTimeout(() => {
            const newToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.' + btoa(JSON.stringify({
                userId: 3,
                email: 'user@gmail.com',
                role: 'user',
                exp: Math.floor(Date.now() / 1000) + (15 * 60) // 15 minutes
            }));
            
            localStorage.setItem('token', newToken);
            localStorage.setItem('refreshToken', 'refresh_' + Date.now());
            
            detailsDiv.innerHTML = `
                <div class="alert alert-success mb-2">
                    <strong>‚úÖ Token refreshed successfully!</strong>
                </div>
                <small class="text-muted">
                    <strong>New Access Token:</strong> ${newToken.substring(0, 50)}...<br>
                    <strong>Expires:</strong> ${new Date(Date.now() + 15*60*1000).toLocaleString()}<br>
                    <strong>Refresh Token:</strong> Valid for 7 days
                </small>
            `;
        }, 1500);
    }
    
    function demoExpireToken() {
        const statusDiv = document.getElementById('tokenStatus');
        const detailsDiv = document.getElementById('tokenDetails');
        
        statusDiv.style.display = 'block';
        detailsDiv.innerHTML = `
            <div class="alert alert-warning mb-2">
                <strong>‚ö†Ô∏è Access Token Expired!</strong>
            </div>
            <small class="text-muted">
                Simulating expired token scenario...<br>
                Auto-refresh will trigger in a real application.
            </small>
            <div class="mt-2">
                <button class="btn btn-primary btn-sm" onclick="demoRefreshToken()">
                    üîÑ Auto Refresh Now
                </button>
            </div>
        `;
    }
    
    function showTokenInfo() {
        const statusDiv = document.getElementById('tokenStatus');
        const detailsDiv = document.getElementById('tokenDetails');
        const token = localStorage.getItem('token') || 'No token found';
        const refreshToken = localStorage.getItem('refreshToken') || 'No refresh token';
        
        statusDiv.style.display = 'block';
        detailsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Access Token:</strong><br>
                    <small class="text-muted font-monospace">${token.substring(0, 100)}${token.length > 100 ? '...' : ''}</small>
                </div>
                <div class="col-md-6">
                    <strong>Refresh Token:</strong><br>
                    <small class="text-muted font-monospace">${refreshToken}</small><br><br>
                    <strong>Status:</strong> <span class="badge bg-success">Active</span><br>
                    <strong>Last Refresh:</strong> ${new Date().toLocaleString()}
                </div>
            </div>
        `;
    }

    // Add some interactive features
    document.addEventListener('DOMContentLoaded', function() {
        // Add click effects to buttons
        const buttons = document.querySelectorAll('.btn-custom');
        buttons.forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.onclick) {
                    this.classList.add('animate__pulse');
                    setTimeout(() => {
                        this.classList.remove('animate__pulse');
                    }, 1000);
                }
            });
        });
        
    // NOTE: do NOT auto-create a demo token here. Creating a non-JWT demo token
    // breaks server-side JWT verification (jwt malformed). Only set tokens
    // after a successful login flow.

        // Add event listener for add user form
        const addUserForm = document.getElementById('addUserForm');
        if (addUserForm) {
            addUserForm.addEventListener('submit', addNewUser);
        }
    });
</script>
  <!-- Avatar Upload Modal -->
  <div class="modal" tabindex="-1" id="avatarUploadModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Avatar</h5>
          <button type="button" class="btn-close" onclick="closeAvatarUploadModal()"></button>
        </div>
        <div class="modal-body">
          <div id="dropZoneModal" class="p-4 text-center" style="border:2px dashed #ddd; border-radius:8px; cursor:pointer;">
            <div id="dropText">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn (Max 5MB)</div>
            <input type="file" id="avatarFileModal" accept="image/*" style="display:none">
            <img id="avatarPreviewModal" src="" style="max-width:180px; display:none; margin-top:12px; border-radius:8px">
          </div>
          <div id="uploadProgressModal" class="mt-3" style="display:none">
            <div class="progress"><div id="uploadBarModal" class="progress-bar" style="width:0%"></div></div>
            <div id="uploadStatusModal" class="small mt-2 text-muted">ƒêang upload...</div>
          </div>
          <div id="uploadResultModal" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeAvatarUploadModal()">ƒê√≥ng</button>
          <button id="btnUploadModal" class="btn btn-primary" onclick="submitAvatarModal()" disabled>Upload</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Avatar modal logic
    const avatarFileModal = document.getElementById('avatarFileModal');
    const dropZoneModal = document.getElementById('dropZoneModal');
    const previewModal = document.getElementById('avatarPreviewModal');
    const btnUploadModal = document.getElementById('btnUploadModal');

    function openAvatarUploadModal() {
      const modal = new bootstrap.Modal(document.getElementById('avatarUploadModal'));
      modal.show();
      // reset
      avatarFileModal.value = '';
      previewModal.style.display = 'none';
      btnUploadModal.disabled = true;
      document.getElementById('uploadProgressModal').style.display = 'none';
      document.getElementById('uploadResultModal').innerHTML = '';
    }

    function closeAvatarUploadModal() {
      const modalEl = document.getElementById('avatarUploadModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    }

    dropZoneModal.addEventListener('click', () => avatarFileModal.click());
    dropZoneModal.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneModal.classList.add('dragover'); });
    dropZoneModal.addEventListener('dragleave', () => dropZoneModal.classList.remove('dragover'));
    dropZoneModal.addEventListener('drop', (e) => { e.preventDefault(); dropZoneModal.classList.remove('dragover'); handleModalFile(e.dataTransfer.files[0]); });
    avatarFileModal.addEventListener('change', (e) => { if (e.target.files[0]) handleModalFile(e.target.files[0]); });

    function handleModalFile(file) {
      if (!file.type.startsWith('image/')) return alert('Vui l√≤ng ch·ªçn file ·∫£nh');
      if (file.size > 5 * 1024 * 1024) return alert('File qu√° l·ªõn (t·ªëi ƒëa 5MB)');
      const reader = new FileReader();
      reader.onload = (ev) => { previewModal.src = ev.target.result; previewModal.style.display = 'block'; btnUploadModal.disabled = false; };
      reader.readAsDataURL(file);
      // store selected file on element for upload
      avatarFileModal._selected = file;
    }

    async function submitAvatarModal() {
      const file = avatarFileModal._selected;
      if (!file) return alert('Ch∆∞a ch·ªçn file');
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) return alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');

      const form = new FormData();
      form.append('avatar', file);
      // attach current user's email so the dev-fallback server can persist avatar for mock users
      try {
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        if (currentUser && currentUser.email) form.append('email', currentUser.email);
      } catch(e) { /* ignore */ }

      document.getElementById('uploadProgressModal').style.display = 'block';
      document.getElementById('uploadBarModal').style.width = '0%';
      document.getElementById('uploadStatusModal').textContent = 'ƒêang upload...';

      try {
        // Helper to send via XHR and return a promise
        const sendTo = (url) => new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url);
          xhr.setRequestHeader('Authorization', 'Bearer ' + token);

          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded / e.total) * 100);
              document.getElementById('uploadBarModal').style.width = pct + '%';
              document.getElementById('uploadStatusModal').textContent = `ƒêang upload... ${pct}%`;
            }
          });

          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              const status = xhr.status;
              const text = xhr.responseText;
              if (status >= 200 && status < 300) return resolve({ status, text });
              return reject({ status, text });
            }
          };

          xhr.onerror = () => reject({ status: 0, text: 'Network error' });
          xhr.send(form);
        });

        // Try same-origin first, then common backend ports
        const candidates = [
          '/api/avatar/upload',
          'http://localhost:5000/api/avatar/upload',
          'http://localhost:3000/api/avatar/upload'
        ];

        let lastError = null;
        for (const url of candidates) {
          try {
            const result = await sendTo(url);
            // success
            let successMsg = '<div class="alert alert-success">Upload th√†nh c√¥ng!</div>';
            try {
              const parsed = JSON.parse(result.text);
              if (parsed && parsed.message) successMsg = `<div class="alert alert-success">${parsed.message}</div>`;

              // If server returned an avatar path/url, normalize and persist it so UI updates immediately
              let avatarUrl = parsed && (parsed.data && parsed.data.avatar) || parsed && parsed.avatar || null;
              if (avatarUrl) {
                // If returned path is relative (starts with '/'), make it absolute
                if (avatarUrl.startsWith('/')) avatarUrl = window.location.origin + avatarUrl;

                try {
                  const stored = JSON.parse(localStorage.getItem('user') || '{}');
                  stored.avatar = avatarUrl;
                  localStorage.setItem('user', JSON.stringify(stored));
                } catch (e) {
                  console.warn('Could not persist avatar to localStorage', e);
                }

                // Update the dashboard avatar element immediately
                const avatarEl = document.getElementById('userAvatar');
                if (avatarEl) avatarEl.src = avatarUrl;
                // Also try to persist avatar to the mock auth users (so login/logout cycles will see it)
                try {
                  const stored = JSON.parse(localStorage.getItem('user') || '{}');
                  if (stored && stored.email) {
                    // call mock API to update avatar for this email
                    fetch(`/api/auth/users/${encodeURIComponent(stored.email)}/avatar`, {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ avatar: avatarUrl })
                    }).then(r => r.json()).then(j => console.log('Persisted avatar to mock auth:', j)).catch(e => console.warn('Could not persist avatar to mock auth', e));
                  }
                } catch(e) { /* ignore */ }
              }
            } catch(e) {
              console.warn('Could not parse upload response JSON', e);
            }

            document.getElementById('uploadResultModal').innerHTML = successMsg;
            // attempt to reload avatar via helper if present
            if (window.loadAvatarInto) window.loadAvatarInto('#avatarContainer');
            return;
          } catch (errObj) {
            lastError = errObj;
            // If 404, try next candidate; otherwise show the error
            if (errObj && errObj.status === 404) {
              // try next
              continue;
            } else {
              const msg = errObj && errObj.text ? errObj.text : 'L·ªói k·∫øt n·ªëi';
              document.getElementById('uploadResultModal').innerHTML = `<div class="alert alert-danger">Upload th·∫•t b·∫°i: ${errObj.status || '?'} - ${msg}</div>`;
              return;
            }
          }
        }

        // If we exhausted candidates
        document.getElementById('uploadResultModal').innerHTML = `<div class="alert alert-danger">Upload th·∫•t b·∫°i: Kh√¥ng t√¨m th·∫•y endpoint (404). C·ªë g·∫Øng ch·∫°y backend tr√™n c·ªïng ƒë√∫ng ho·∫∑c c·∫•u h√¨nh proxy.</div>`;

      } catch (err) {
        console.error('Upload error', err);
        document.getElementById('uploadResultModal').innerHTML = '<div class="alert alert-danger">L·ªói: ' + (err && err.message ? err.message : err) + '</div>';
      }
    }
  </script>

</body>
</html>
