<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∑ Advanced Avatar Upload - Activity 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-cloud-arrow-up"></i> üì∑ Advanced Avatar Upload
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    üë§ <span id="navUserInfo">Loading...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-primary">
                            <i class="bi bi-camera"></i> üì∑ Advanced Avatar Upload
                        </h2>
                        <p class="text-muted">
                            <strong>Activity 3:</strong> Upload ·∫£nh n√¢ng cao v·ªõi Multer + Sharp + Cloudinary + JWT
                        </p>
                    </div>
                    <a href="profile.html" class="btn btn-secondary">
                        <i class="bi bi-person-circle"></i> üë§ H·ªì s∆°
                    </a>
                </div>
            </div>
        </div>

        <!-- Current Avatar Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üñºÔ∏è Avatar hi·ªán t·∫°i</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="current-avatar-container mb-3">
                            <img id="currentAvatar" src="" alt="Current Avatar" 
                                 class="rounded-circle" width="200" height="200" 
                                 style="border: 4px solid #ddd; object-fit: cover;">
                        </div>
                        <div id="avatarInfo">
                            <p class="text-muted">Loading avatar info...</p>
                        </div>
                        <button id="deleteAvatarBtn" class="btn btn-outline-danger" onclick="deleteCurrentAvatar()" style="display: none;">
                            <i class="bi bi-trash"></i> üóëÔ∏è X√≥a Avatar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üì§ Upload Avatar m·ªõi</h5>
                    </div>
                    <div class="card-body">
                        <!-- Upload Area -->
                        <div id="uploadSection">
                            <div id="dropZone" class="upload-zone border-2 border-dashed rounded p-5 text-center">
                                <div id="uploadContent">
                                    <div class="upload-icon mb-3">
                                        <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #6c757d;"></i>
                                    </div>
                                    <h4 class="text-primary">üìÅ K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
                                    <p class="text-muted">
                                        H·ªó tr·ª£: JPG, JPEG, PNG, WEBP ‚Ä¢ T·ªëi ƒëa: 5MB<br>
                                        <small><strong>Powered by:</strong> Multer + Sharp + Cloudinary</small>
                                    </p>
                                    <button type="button" class="btn btn-primary">
                                        <i class="bi bi-folder2-open"></i> üìÇ Ch·ªçn file
                                    </button>
                                </div>

                                <!-- Preview Section -->
                                <div id="previewSection" style="display: none;">
                                    <div class="preview-container mb-3">
                                        <img id="previewImg" src="" alt="Preview" class="rounded" style="max-width: 300px; max-height: 300px;">
                                    </div>
                                    <div id="fileInfo" class="mb-3">
                                        <p class="text-info"></p>
                                    </div>
                                    <div class="preview-actions">
                                        <button type="button" class="btn btn-success btn-lg" onclick="uploadAvatar()">
                                            <i class="bi bi-cloud-arrow-up"></i> üöÄ Upload l√™n Cloudinary
                                        </button>
                                        <button type="button" class="btn btn-secondary ms-2" onclick="resetUpload()">
                                            <i class="bi bi-arrow-clockwise"></i> üîÑ Ch·ªçn l·∫°i
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div id="progressSection" style="display: none;">
                            <div class="progress-container mt-4">
                                <h5 class="text-center mb-3">üì° ƒêang upload...</h5>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                         style="width: 0%; font-size: 14px;" role="progressbar">
                                        <span id="progressText">ƒêang chu·∫©n b·ªã...</span>
                                    </div>
                                </div>
                                <div id="uploadStatus" class="text-center">
                                    <p class="text-muted">
                                        <i class="bi bi-gear spin"></i> Processing with Sharp + Cloudinary...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Result Section -->
                        <div id="resultSection" style="display: none;">
                            <div id="successMessage" class="alert alert-success" style="display: none;">
                                <h5><i class="bi bi-check-circle"></i> ‚úÖ Upload th√†nh c√¥ng!</h5>
                                <p class="mb-0">Avatar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√† l∆∞u v√†o Cloudinary + MongoDB.</p>
                            </div>
                            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                                <h5><i class="bi bi-exclamation-triangle"></i> ‚ùå Upload th·∫•t b·∫°i!</h5>
                                <p class="mb-0" id="errorText">C√≥ l·ªói x·∫£y ra khi upload avatar.</p>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> üîÑ Upload ·∫£nh kh√°c
                                </button>
                                <a href="profile.html" class="btn btn-success ms-2">
                                    <i class="bi bi-person-circle"></i> üë§ Xem h·ªì s∆°
                                </a>
                            </div>
                        </div>

                        <!-- Hidden File Input -->
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Info -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">üîß Technical Implementation - Activity 3</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">üéØ SV1: Backend Features</h6>
                                <ul class="small">
                                    <li><strong>API:</strong> <code>POST /api/avatar/upload</code></li>
                                    <li><strong>Multer:</strong> File upload handling</li>
                                    <li><strong>Sharp:</strong> Image resizing (300x300px)</li>
                                    <li><strong>JWT:</strong> Authentication middleware</li>
                                    <li><strong>MongoDB:</strong> Avatar URL storage</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">üéØ SV2: Frontend Features</h6>
                                <ul class="small">
                                    <li><strong>Drag & Drop:</strong> File selection</li>
                                    <li><strong>Preview:</strong> Before upload</li>
                                    <li><strong>Progress:</strong> Upload tracking</li>
                                    <li><strong>JWT Token:</strong> Secure upload</li>
                                    <li><strong>Error Handling:</strong> User feedback</li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-warning">üéØ SV3: Cloudinary Integration</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Cloud Name:</strong> <code id="cloudName">Loading...</code>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Folder:</strong> <code>group11_avatars</code>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Transformation:</strong> <code>300x300, auto quality</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:5173';
        const MONGODB_AUTH_URL = `${API_BASE_URL}/api/auth-mongo`;
        const AVATAR_API_URL = `${API_BASE_URL}/api/avatar`;
        
        let selectedFile = null;
        let currentUser = null;
        let authToken = null;

        // Initialize page
        window.addEventListener('load', () => {
            initializePage();
        });

        async function initializePage() {
            console.log('üöÄ Initializing Advanced Avatar Upload page');
            
            // Get user from localStorage
            const userData = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!userData || !token) {
                alert('‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y!');
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            authToken = token;
            
            // Display user info
            document.getElementById('navUserInfo').textContent = `${currentUser.fullname} (${currentUser.role})`;
            
            // Load current avatar
            await loadCurrentAvatar();
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // Load Cloudinary info
            loadCloudinaryInfo();
        }

        async function loadCurrentAvatar() {
            try {
                console.log('üîÑ Loading current avatar...');
                
                const response = await fetch(`${AVATAR_API_URL}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('üì° Avatar info response:', data);

                if (data.success) {
                    const avatarData = data.data;
                    const currentAvatarImg = document.getElementById('currentAvatar');
                    
                    if (avatarData.avatar) {
                        currentAvatarImg.src = avatarData.avatar;
                        document.getElementById('avatarInfo').innerHTML = `
                            <p class="text-success">‚úÖ Avatar ƒë√£ c√≥</p>
                            <small class="text-muted">URL: ${avatarData.avatar}</small>
                        `;
                        document.getElementById('deleteAvatarBtn').style.display = 'inline-block';
                    } else {
                        currentAvatarImg.src = `https://via.placeholder.com/200/cccccc/666666?text=${encodeURIComponent(currentUser.fullname)}`;
                        document.getElementById('avatarInfo').innerHTML = `
                            <p class="text-warning">‚ö†Ô∏è Ch∆∞a c√≥ avatar</p>
                            <small class="text-muted">Placeholder image</small>
                        `;
                        document.getElementById('deleteAvatarBtn').style.display = 'none';
                    }
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('‚ùå Error loading avatar:', error);
                const currentAvatarImg = document.getElementById('currentAvatar');
                currentAvatarImg.src = `https://via.placeholder.com/200/cccccc/666666?text=${encodeURIComponent(currentUser.fullname)}`;
                document.getElementById('avatarInfo').innerHTML = `
                    <p class="text-danger">‚ùå Kh√¥ng th·ªÉ load avatar</p>
                    <small class="text-muted">${error.message}</small>
                `;
            }
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // Click to select file
            dropZone.addEventListener('click', () => {
                if (!selectedFile) {
                    fileInput.click();
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.backgroundColor = '#e3f2fd';
                dropZone.style.borderColor = '#2196f3';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.backgroundColor = '';
                dropZone.style.borderColor = '';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.backgroundColor = '';
                dropZone.style.borderColor = '';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            console.log('üìé File selected:', file);

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh: JPG, JPEG, PNG, WEBP');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå File qu√° l·ªõn! K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 5MB.');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadContent').style.display = 'none';
                document.getElementById('previewSection').style.display = 'block';
                
                // Display file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                document.querySelector('#fileInfo p').innerHTML = `
                    üìÅ <strong>${file.name}</strong><br>
                    üìä Size: ${fileSize} MB ‚Ä¢ Type: ${file.type}
                `;
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            selectedFile = null;
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        async function uploadAvatar() {
            if (!selectedFile) {
                alert('‚ùå Vui l√≤ng ch·ªçn file tr∆∞·ªõc!');
                return;
            }

            if (!authToken) {
                alert('‚ùå Kh√¥ng c√≥ token x√°c th·ª±c!');
                return;
            }

            console.log('üöÄ Starting avatar upload...');

            // Hide preview, show progress
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';

            // Create FormData
            const formData = new FormData();
            formData.append('avatar', selectedFile);

            // Simulate progress
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `Uploading... ${Math.round(progress)}%`;
            }, 200);

            try {
                // Upload to server
                console.log('üì° Uploading to:', `${AVATAR_API_URL}/upload`);
                
                const response = await fetch(`${AVATAR_API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                        // Don't set Content-Type for FormData
                    },
                    body: formData
                });

                const data = await response.json();
                console.log('üì° Upload response:', data);

                // Complete progress
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Upload completed!';

                // Show result
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'block';

                    if (data.success) {
                        // Success
                        document.getElementById('successMessage').style.display = 'block';
                        document.getElementById('errorMessage').style.display = 'none';
                        
                        // Update current avatar display
                        if (data.data && data.data.user && data.data.user.avatar) {
                            document.getElementById('currentAvatar').src = data.data.user.avatar;
                            
                            // Update localStorage
                            const updatedUser = { ...currentUser, avatar: data.data.user.avatar };
                            localStorage.setItem('user', JSON.stringify(updatedUser));
                        }
                        
                        console.log('‚úÖ Avatar upload successful!');
                    } else {
                        // Error
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('successMessage').style.display = 'none';
                        document.getElementById('errorText').textContent = data.message || 'Unknown error';
                        
                        console.error('‚ùå Upload failed:', data.message);
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Upload error:', error);
                
                clearInterval(progressInterval);
                
                // Show error
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorText').textContent = 'Network error: ' + error.message;
            }
        }

        async function deleteCurrentAvatar() {
            if (!confirm('‚ùì B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a avatar hi·ªán t·∫°i?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Deleting current avatar...');
                
                const response = await fetch(`${AVATAR_API_URL}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('üì° Delete response:', data);

                if (data.success) {
                    alert('‚úÖ Avatar ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                    await loadCurrentAvatar();
                    
                    // Update localStorage
                    const updatedUser = { ...currentUser, avatar: null };
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                } else {
                    alert('‚ùå ' + data.message);
                }

            } catch (error) {
                console.error('‚ùå Delete error:', error);
                alert('‚ùå L·ªói khi x√≥a avatar: ' + error.message);
            }
        }

        function loadCloudinaryInfo() {
            // This would normally come from an API call
            document.getElementById('cloudName').textContent = 'dkggmxtoq'; // From .env
        }

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                localStorage.removeItem('authToken');
                alert('üëã ƒê√£ ƒëƒÉng xu·∫•t!');
                window.location.href = 'login.html';
            }
        }
    </script>

    <style>
        .upload-zone {
            min-height: 300px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            background-color: #f8f9fa;
            border-color: #6c757d !important;
        }

        .preview-container img {
            border: 2px solid #dee2e6;
            border-radius: 10px;
        }

        .progress {
            border-radius: 10px;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .current-avatar-container img {
            transition: transform 0.3s ease;
        }

        .current-avatar-container img:hover {
            transform: scale(1.05);
        }
    </style>
</body>
</html>